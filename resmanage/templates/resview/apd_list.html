{% extends "resview/shape.html" %}
{% load utils %}
{% block resview %}

    <div style="padding-top:30px; padding-bottom:16px; width: 100%;">
        <h2>测试</h2>
    </div>
    <div id="pagenum" style="opacity:0; height:1px; font-size:1%">
        1
    </div>
    <div style="margin:20px">
        <table class="table table-hover table-striped" 
            style="padding-left: 10px;padding-right: 10px; border-top:1px lightgray solid"> 
            <thead>
                <tr>
                    <th scope="col">序号</th>
                    <th scope="col">用户</th>
                    <th scope="col">记录ID</th>
                    <th scope="col">预约日期</th>
                    <th scope="col">预约通道</th>
                    <th scope="col">状态</th>
                    <th scope="col">审核员</th>
                    <th scope="col">邀请人</th>
                    <th scope="col">通过时间</th>
                    <th scope="col">操作</th>
                </tr>
            </thead>

            <tbody id="vlist" class="all_tb">
            </tbody>

        </table>
    </div>

    <script>
        function get_res_list(page_num = 1) {

        $.ajax({
            url: '{% url "get_apd_report" %}',
            method: "post",
            dataType: "text",
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}',
                "page_num": page_num,
            },
            success: function (data) {
                var data = JSON.parse(data);
                const table = $('#vlist');
                const pagein = $("#nav");
                var start = data.current_start;
                var page = data.page;
                var is_paginated = data.is_paginated;
                var if_has_previous = data.if_has_previous;
                var if_has_next = data.if_has_next;
                var num_page = data.page_last;
                var pagenum = data.pagenum;
                $("#pagenum").text(pagenum);

                if (is_paginated) {
                    pagein.empty();
                    var paginationContent = '';
                    for (var i = 1; i < num_page + 1; i++) {
                        if (pagenum == i) {
                            paginationContent +=
                                `<li class="page-item active"><span class="page-link">${i}<span class="sr-only"></span></span></li>`;
                        } else {
                            paginationContent +=
                                `<li class="page-item"><a class="page-link" href="javascript:viod(0)" onclick="get_res_list(page_num=${i})">${i}</a></li>`;
                        }
                    };
                    pagein.append(paginationContent);

                    if (if_has_previous) {
                        var pre_page = pagenum - 1;
                        pagein.prepend(
                            '<li class="page-item"><a class="page-link" href="javascript:viod(0)" onclick="get_res_list(page_num=' +
                            pre_page + ')">上一页</a></li>');
                    } else {
                        pagein.prepend(
                            '<li class="page-item disabled"><span class="page-link">上一页</span></li>');
                    };
                    if (if_has_next) {
                        var next_page = pagenum + 1;
                        pagein.append(
                            '<li class="page-item"><a class="page-link" href="javascript:viod(0)" onclick="get_res_list(page_num=' +
                            next_page + ')">下一页</a></li>');
                    } else {
                        pagein.append(
                            '<li class="page-item disabled"><span class="page-link">下一页</span></li>');
                    }
                };

                table.empty(); // 清空表格内容 
                for (var i = 0; i < page.length; i++) {
                    var iteme = page[i];
                    var item = iteme.origin_resvation;
                    var startdate = item.res_start_time.substring(0, 10);
                    if (item.inviter != null) {
                        var inviter = item.inviter.username;
                    } else {
                        var inviter = "无";
                    };
                    if (item.audit_staff != null) {
                        var audit_staff = item.audit_staff.username;
                    } else {
                        var audit_staff = "无";
                    };
                    if(iteme.completed_time != null){
                        var cptime = iteme.completed_time;
                    }else{
                        var cptime = "未通过";
                    };

                    var row = `  
                        <tr>  
                        <th class="tbr align-middle" scope="row">${i + 1 + start}</th>  
                        <td class="tbr align-middle">${item.res_user.username}</td>  
                        <td class="tbr align-middle">${iteme.id}</td>
                        <td class="tbr align-middle">${startdate}</td>  
                        <td class="tbr align-middle">${item.device.name}</td>  
                        
                        <td class="tbr align-middle" >${iteme.state_apd}</td>
                        <td class="tbr align-middle">${audit_staff}</td>  
                        <td class="tbr align-middle">${inviter}</td>  
                        <td class="tbr align-middle">${cptime}</td>
                        <td>  
                        <button class="btn btn-info btn-sm">操作1</button>
                        </td>  
                        </tr>  
                        `;
                    table.append(row);
                };
            }
        });
    };
    </script>

{% endblock resview %}